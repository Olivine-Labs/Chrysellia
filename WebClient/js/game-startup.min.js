$(function(){window.chatTabIndex=0;$("#myCharacter_ExperienceBar").progressbar();$("#myCharacter_HealthBar").progressbar();vc.cs.GetCurrentCharacter(SelectCharacter);$("#chatForm").bind("submit",function(a){a.preventDefault();SubmitMessage()});window.$tabs=$("#chatChannels").tabs({tabTemplate:'<li><a href="#{href}" class="chatChannelLabel">#{label}</a> <span class="ui-icon ui-icon-close">Remove Tab</span></li>',add:function(a,b){$(b.panel).append("<div />");$tabs.tabs("select","#"+b.panel.id)},select:function(a,
b){window.MyCharacter.CurrentChannel=$(".channelId",b.panel).val();$(b.tab).parent().removeClass("newMessage")}});$("#chatChannels span.ui-icon-close").live("click",function(){var a=$(".channelId",$($(this).siblings("a").attr("href"))).val();a!=vc.ch.StaticRooms.General&&a!=vc.ch.StaticRooms.Trade&&LeaveChannel(a)});$("#createChannelForm").dialog({autoOpen:false,title:"Create Chat Channel",width:400});$("#joinChannelForm").dialog({autoOpen:false,title:"Join Chat Channel",width:400});$("#createChannelForm form").bind("submit",
function(a){a.preventDefault();a=$("#cc_channelName").val();var b=$("#cc_channelMOTD").val();vc.ch.CreateChannel(a,b,CreateChannel)});$("#joinChannelForm form").bind("submit",function(a){a.preventDefault();a=$("#jc_channelName").val();vc.ch.JoinChannel(a,JoinChannel)});$("#quickLoginForm .button").bind("click",function(a){a.preventDefault();vc.as.Logout(Logout)});$("#createChannelLink").bind("click",function(){$("#createChannelForm").dialog("open")});$("#joinChannelLink").bind("click",function(){$("#joinChannelForm").dialog("open")});
$("#moveNW").button({icons:{primary:"ui-icon-arrowthick-1-nw"},text:false});$("#moveN").button({icons:{primary:"ui-icon-arrowthick-1-n"},text:false});$("#moveNE").button({icons:{primary:"ui-icon-arrowthick-1-ne"},text:false});$("#moveW").button({icons:{primary:"ui-icon-arrowthick-1-w"},text:false});$("#moveE").button({icons:{primary:"ui-icon-arrowthick-1-e"},text:false});$("#moveSW").button({icons:{primary:"ui-icon-arrowthick-1-sw"},text:false});$("#moveS").button({icons:{primary:"ui-icon-arrowthick-1-s"},
text:false});$("#moveSE").button({icons:{primary:"ui-icon-arrowthick-1-se"},text:false});$("#moveLook").button({icons:{primary:"ui-icon-search"},text:false}).bind("click",function(a){a.preventDefault();vc.cs.PlayerListByLocation(ExamineLocation)});$("#movementform button").bind("click",function(a){a.preventDefault();$this=$(this);if(!$this.hasClass("look")){SetEnableMovement(false);a=$this.siblings(".x").val()*1;var b=$this.siblings(".y").val()*1,d=a+MyCharacter.PositionX*1,e=b+MyCharacter.PositionY*
1;if(d>MyCharacter.CurrentMap.DimensionX-1||MyCharacter.PositionX<0)d=MyCharacter.PositionX;if(e>MyCharacter.CurrentMap.DimensionY-1||e<0)e=MyCharacter.PositionY;vc.ms.Move(d,e,RefreshMap);a+b==1||a+b==-1?window.setTimeout(function(){SetEnableMovement(true)},750):window.setTimeout(function(){SetEnableMovement(true)},1060)}});$("#statsWindow").dialog({title:"Character Stats",autoOpen:false});$("#itemsWindow").dialog({title:"Inventory",autoOpen:false});$(".accountActions .logOut").bind("click",function(a){a.preventDefault();
vc.as.Logout(Logout)});$("#statsWindowButton").bind("click",function(a){a.preventDefault();$("#statsWindow").dialog("open")});$(".chooseStats").live("click",function(a){a.preventDefault();$("#statsWindow").dialog("open")});$("#itemsWindowButton").bind("click",function(a){a.preventDefault();$("#itemsWindow").dialog("open")});$(".chatMessage.system a.joinChannel").live("click",function(a){a.preventDefault();$this=$(this);a=$this.siblings(".channelName").text();vc.ch.JoinChannel(a,JoinChannel);$this.parentsUntil(".ui-dialog").parent().dialog("destroy").remove()});
$("#itemsWindow select").live("change",function(){$this=$(this);var a=$this.attr("class").split(" ")[0];$("#itemsWindow select").attr("disabled","disabled");var b=$this.attr("class").split(" ")[1].replace(/itemType_/,"")*1;a=$("#itemsWindow select."+a).index($this);$this.val()==0?vc.is.UnEquip(window.MyCharacter.Equipment[b][a].ItemId,b,a,UnEquipItem):vc.is.Equip($this.val(),b,a,EquipItem)});$(window).resize(function(){$("#chatChannels .ui-tabs-panel").css({height:$(window).height()-432+"px"})});
$("#statsWindow button").bind("click",function(a){a.preventDefault();$(".chooseStats").remove();switch($(this).parent().attr("class")){case "stat str":vc.cs.LevelUp(1,LevelUpResponse);break;case "stat dex":vc.cs.LevelUp(2,LevelUpResponse);break;case "stat vit":vc.cs.LevelUp(3,LevelUpResponse);break;case "stat int":vc.cs.LevelUp(4,LevelUpResponse);break;case "stat wis":vc.cs.LevelUp(5,LevelUpResponse);break;case "stat all":vc.cs.LevelUp(0,LevelUpResponse)}})});
function ExamineLocation(a){if(a.Result==vc.ER_SUCCESS){$("optgroup[label='Other Players']").remove();var b=$("<optgroup label='Other Players' />"),d="",e="",f="";for(c in a.Data)if(c!="remove"){f=a.Data[c].CharacterId;d=a.Data[c].Name;e=a.Data[c].Level;option=$("<option value='"+f+"'>"+d+" ("+e+")</option>").appendTo(b)}b.appendTo($("#monsterList"))}}
function LevelUpResponse(a,b){if(a.Result==vc.ER_SUCCESS){switch(b){case 0:MyCharacter.Strength+=12;MyCharacter.Dexterity+=12;MyCharacter.Vitality+=12;MyCharacter.Intelligence+=12;MyCharacter.Wisdom+=12;break;case 1:MyCharacter.Strength+=50;break;case 2:MyCharacter.Dexterity+=50;break;case 3:MyCharacter.Vitality+=50;break;case 4:MyCharacter.Intelligence+=50;break;case 5:MyCharacter.Wisdom+=50}MyCharacter.Strength+=MyCharacter.RacialStrength;MyCharacter.Dexterity+=MyCharacter.RacialDexterity;MyCharacter.Vitality+=
MyCharacter.RacialVitality;MyCharacter.Intelligence+=MyCharacter.RacialIntelligence;MyCharacter.Wisdom+=MyCharacter.RacialWisdom;MyCharacter.Level++;MyCharacter.FreeLevels--;MyCharacter.FreeLevels<1&&$("#statsWindow button, #statsWindow .all").hide();vc.i.UpdateStats()}}
function EquipItem(a,b,d,e){if(a.Result==vc.ER_SUCCESS){a={};var f=vc.is.TypeMapping,g;for(g in window.MyCharacter.Inventories.Personal)if(g!="remove")if(window.MyCharacter.Inventories.Personal[g].ItemId==b){window.MyCharacter.Equipment[d][e]=window.MyCharacter.Inventories.Personal[g];window.MyCharacter.Inventories.Personal.remove(g)}a=window.MyCharacter.Equipment[d][e];$("option[value="+a.ItemId+"]").remove();$("<option value='"+a.ItemId+"' selected='selected'>"+a.Name+"</option>").appendTo($("select."+
f[a.SlotType]).eq(e))}$("#itemsWindow select").removeAttr("disabled")}
function UnEquipItem(a,b,d,e){if(a.Result==vc.ER_SUCCESS){a=window.MyCharacter.Equipment[d][e];b=vc.is.TypeMapping;$("option[value="+a.ItemId+"]").remove();$("<option value='"+a.ItemId+"'>"+a.Name+"</option>").appendTo($("select."+b[a.SlotType]));window.MyCharacter.Inventories.Personal[window.MyCharacter.Inventories.Personal.length]=a;window.MyCharacter.Equipment[d][e]={}}$("#itemsWindow select").removeAttr("disabled");MyCharacter.CurrentMap.Places[MyCharacter.PositionY][MyCharacter.PositionX].Type==0&&
BuildGameWindow()}function RefreshMap(a){if(a.Result==vc.ER_SUCCESS){MyCharacter.PositionX=a.Data.X;MyCharacter.PositionY=a.Data.Y;BuildMap()}}function SetEnableMovement(a){$("#movementform button").button("option","disabled",!a).removeClass("ui-state-hover")}function SetEnableAttack(a){$("#fightForm button").button("option","disabled",!a).removeClass("ui-state-hover")}
function CreateChannel(a){if(a.Result==vc.ER_SUCCESS){$("#cc_channelName, #cc_channelMOTD").val("");$("#createChannelForm").dialog("close");AddTab(a.Data.Name,a.Data.ChannelId,a.Data.Motd);window.MyCharacter.Channels[a.Data.ChannelId]={Motd:a.Data.Motd,Name:a.Data.Name,Permissions:{Read:1,Write:1,Moderate:1,Administrate:1,isJoined:1}}}else a.Result==vc.ER_ALREADYEXISTS?alert("Channel name already exists!"):alert("An error has occured.")}
function JoinChannel(a){if(a.Result==vc.ER_SUCCESS){$("#jc_channelName, #cc_channelMOTD").val("");$("#joinChannelForm").dialog("close");AddTab(a.Data.Name,a.Data.ChannelId,a.Data.Motd);a.Data.Permissions.isJoined=1;window.MyCharacter.Channels[a.Data.ChannelId]={Motd:a.Data.Motd,Name:a.Data.Name,Permissions:a.Data.Permissions}}else alert("An error has occured.")}
function LeaveChannel(a){var b=$("#chatChannels input[value='"+a+"']").parent();b=$("a[href='#"+b.attr("id")+"']").parent();var d=$("li",$tabs).index(b);vc.ch.PartChannel(a,function(){$tabs.tabs("remove",d)});delete window.MyCharacter.Channels[a]}
function AddTab(a,b,d){$tabs.tabs("add","#channelTabs-"+chatTabIndex,a.replace(/</g,"&lt;").replace(/>/g,"&gt;"));$("<input type='hidden' value='"+b+"' class='channelId' />").appendTo($("#channelTabs-"+chatTabIndex));InsertChat([{Type:999,FromName:"",Message:d}],b);chatTabIndex++;window.MyCharacter.CurrentChannel=b}
function FillChat(a){if(a.Result==vc.ER_SUCCESS)for(var b in a.Data)if(b!="remove")b!=0?InsertChat(a.Data[b],b):ProcessSystemMessage(a.Data[0]);$(".chatMessage:nth-child(n+50)").remove();window.setTimeout(function(){vc.ch.GetMessagesFromChannel(MyCharacter.CurrentChannel,FillChat)},4500)}
function SelectCharacter(a){window.MyCharacter=new Character;if(a.Result==vc.ER_SUCCESS){window.MyCharacter.Construct(a.Data);vc.i.UpdateStats()}else{alert("Please login again.");window.location="./index.php"}for(var b in window.MyCharacter.Channels)b!="remove"&&AddTab(window.MyCharacter.Channels[b].Name,b,window.MyCharacter.Channels[b].Motd);$tabs.tabs("select",0);vc.ch.GetMessagesFromChannel(b,FillChat);vc.is.GetInventory(LoadInventory)}
function BuildMap(){$("#currentMapName").text(MyCharacter.CurrentMap.Name);var a=$("#currentMap");a.empty();for(my=MyCharacter.CurrentMap.DimensionY-1;my>=0;my--){var b=$("<tr />");for(mx=0;mx<MyCharacter.CurrentMap.DimensionY;mx++){var d=$("<td />");my==MyCharacter.PositionY&&mx==MyCharacter.PositionX?d.html("<span class='mapData player'>X</span>"):d.html("<span class='mapData empty'>&nbsp;</span>");d.appendTo(b)}b.appendTo(a)}a.css({height:30*MyCharacter.CurrentMap.DimensionY,width:30*MyCharacter.CurrentMap.DimensionX});
BuildGameWindow()}
function BuildGameWindow(){var a=MyCharacter.CurrentMap.Places[MyCharacter.PositionY][MyCharacter.PositionX],b=$("#topCenter");b.html("&nbsp;");if(a.Type===undefined){if(a.Monsters!==undefined){var d=$("<form id='fightForm'><h1>Fight!</h1><span class='attackLabel'>Attack:</span></form>"),e=$("<select id='monsterList' />");e.appendTo(d);$("<button type='submit' id='attackButton' class='button attack'>Attack</button>").bind("click",function(h){h.preventDefault();Attack(0)}).button().appendTo(d);$("<button type='submit' id='castButton' class='button cast'>Cast</button>").bind("click",
function(h){h.preventDefault();Attack(1)}).button().appendTo(d);var f={},g=$("<optgroup label='Monsters' />");for(m in a.Monsters)if(m!="remove"){f=V2Core.Monsters[a.Monsters[m]];$("<option value='"+f.Id+"'>"+f.Name+"</option>").appendTo(g)}g.appendTo(e);d.appendTo(b);$("<div id='fightResults' class='fightResults'></div>").appendTo(b)}}else switch(a.Type){case 0:BuildShop(b);break;case 1:BuildShrine(b);break;case 2:BuildBank(b);break;case 3:BuildExit(b)}}
function SubmitBankTransaction(){var a=$("#transactionAmount").val();$("#transactionTypeSelection").val()==0?vc.ms.Deposit(a,ProcessBankTransaction):vc.ms.Widthdraw(a,ProcessBankTransaction)}
function ProcessBankTransaction(a){if(a.Result==vc.ER_SUCCESS){a=$("#transactionAmount").val()*1;$("#transactionAmount").val("");if($("#transactionTypeSelection").val()==0){window.MyCharacter.Gold-=a;window.MyCharacter.Bank+=a}else{window.MyCharacter.Gold+=a;window.MyCharacter.Bank-=a}$("#bankTransaction h3").text("You have "+window.MyCharacter.Bank+" gold in your account.");vc.i.UpdateStats()}else alert("You don't have that much gold!")}
function ProcessBankTransfer(a){if(a.Result==vc.ER_SUCCESS){a=$("#transferAmount").val()*1;$("#transferAmount, #transferTarget").val("");window.MyCharacter.Bank-=a;$("#bankTransaction h3").text("You have "+window.MyCharacter.Bank+" gold in your account.");vc.i.UpdateStats()}else alert("You don't have that much gold!")}function SubmitBankTransfer(){var a=$("#transferAmount").val(),b=$("#transferTarget").val();vc.ms.Transfer(a,b,ProcessBankTransfer)}
function BuildExit(a){myLocation=MyCharacter.CurrentMap.Places[MyCharacter.PositionY][MyCharacter.PositionX];var b="Bank";if(myLocation.Name!==undefined)b=myLocation.Name;a.append("<h1>"+b+"</h1>");b=$("<button class='button'>Exit to "+myLocation.ExitTo+"</button>").bind("click",function(d){d.preventDefault();vc.ms.ChangeMap(ProcessMapChange)});b=$("<div class='locationExit'/>").append(b);a.append(b)}
function ProcessMapChange(a){if(a.Result==vc.ER_SUCCESS){window.MyCharacter.CurrentMap=Maps[a.Data.MapId];window.MyCharacter.PositionX=a.Data.PositionX;window.MyCharacter.PositionY=a.Data.PositionY;BuildMap();BuildGameWindow();vc.i.UpdateStats()}}
function BuildBank(a){var b=MyCharacter.CurrentMap.Places[MyCharacter.PositionY][MyCharacter.PositionX],d="Bank";if(b.Name!==undefined)d=b.Name;a.append("<h1>"+d+"</h1>");b=$("<form id='bankTransactionForm'></form>");var e=$("<div id='bankTransaction'><h3>You have "+window.MyCharacter.Bank+" gold in your account.</h3></div>"),f=$("<select id='transactionTypeSelection'><option value='0'>Deposit</option><option value='1'>Withdraw</option></select>"),g=$("<input type='text' id='transactionAmount' />");
d=$("<button id='submitTransaction' class='button'>Submit</buy>").bind("click",function(h){h.preventDefault();SubmitBankTransaction()});e.append(f).append(g).append(d);b.append(e);$("<form id='bankTransferForm'></form>");e=$("<div id='bankTransfer'><h3>Transfer</h3></div>");f=$("<div class='bankTransfer transferAmount'><label for='transferAmount'>Amount:</label> <input type='text' id='transferAmount' /></div>");g=$("<div class='bankTransfer transferTarget'><label for='transferTarget'>Send to:</label> <input type='text' id='transferTarget' /></div>");
d=$("<button id='submitTransaction' class='button'>Transfer</buy>").bind("click",function(h){h.preventDefault();SubmitBankTransfer()});e.append(f).append(g.append(d));b.append(e);a.append(b)}function ReviveCharacter(a){if(a.Result==vc.ER_SUCCESS){MyCharacter.Health=MyCharacter.Vitality;vc.i.UpdateStats();BuildGameWindow()}}
function Attack(a){SetEnableAttack(false);$("#fightResults .result").remove();var b=$("#monsterList").val(),d=$("#fightResults");if(MyCharacter.Health<1)alert("You can't fight! You're dead!");else if(b.indexOf("MONS")>-1){if(MyCharacter.CurrentBattle!==undefined){MyCharacter.CurrentBattle.State==2&&d.html("");if(MyCharacter.CurrentBattle.Enemy==V2Core.Monsters[b])MyCharacter.CurrentBattle.State=1;else MyCharacter.CurrentBattle={Enemy:V2Core.Monsters[b],State:0}}else MyCharacter.CurrentBattle={Enemy:V2Core.Monsters[b],
State:0};MyCharacter.CurrentBattle={Enemy:V2Core.Monsters[b],State:0};vc.mn.Fight(b,a,AttackRound)}else if(b.indexOf("CHAR")>-1){MyCharacter.CurrentBattle={Enemy:{Id:b,Name:$("#monsterList :selected").text()},State:0};vc.cs.Fight(b,a,AttackRound)}}
function AttackRound(a){window.setTimeout(function(){SetEnableAttack(true)},1500);if(a.Result==vc.ER_SUCCESS){var b=$("#fightResults"),d=a.Data;$(".round",b).length>0?$(".round",b).animate({opacity:0},250,function(){$(this).remove();BuildAttackMessage(d,MyCharacter.CurrentBattle.Enemy.Name,true,b)}):BuildAttackMessage(d,MyCharacter.CurrentBattle.Enemy.Name,true,b)}}
function BuildShop(a){var b=MyCharacter.CurrentMap.Places[MyCharacter.PositionY][MyCharacter.PositionX],d="Shop",e=["Weapons","Armors","Spells"];if(b.Name!==undefined)d=b.Name;a.append("<h1>"+d+"</h1>");d=$("<form id='buyForm'></form>");var f=$("<select id='itemTypeSelection'></select>").bind("change",function(){FilterItemTypes($(this).val())});b=$("<select id='itemSelection'></select>");var g=$("<button id='buyItem' class='button'>Purchase</buy>").bind("click",function(j){j.preventDefault();BuyItem()}),
h=$("<button id='itemInfo' class='button'>Info</buy>").bind("click",function(j){j.preventDefault();j=$("#itemSelection option").index($(":selected"));if(j<0)j=0;DisplayItemInfo(vc.ItemTypes[2][$("#itemTypeSelection").val()][j])}),l=$("<div id='itemDescription'></div>"),n=$("<div><label for='itemTypeSelection'>Shop For:</span></div>").append(f).append(b);b={};for(i in vc.ItemTypes[2])if(i!="remove"){items=vc.ItemTypes[2][i];f.append("<option value='"+i+"'>"+e[i]+"</option>")}d.append(n).append(g).append(h).append(l);
a.append(d);e=$("<form id='sellForm'></form>");d=$("<select id='sellSelection'></select>");b={};for(i in MyCharacter.Inventories.Personal)if(i!="remove"){if(i==0)var k=" selected='selected'";b=MyCharacter.Inventories.Personal[i];d.append("<option value='"+b.ItemId+"'"+k+">"+b.Name+" - "+b.SellPrice+"</option>")}k=$("<button id='sellItem' class='button'>Sell</buy>").bind("click",function(j){j.preventDefault();SellItem()});b=$("<button id='sellInfo' class='button'>Info</buy>").bind("click",function(j){j.preventDefault();
j=$("#sellSelection option").index($(":selected"));if(j<0)j=0;DisplayItemInfo(MyCharacter.Inventories.Personal[j])});f=$("<div id='sellDescription'></div>");d=$("<div><label for='sellSelection'>Sell:</span></div>").append(d);e.append(d).append(k).append(b).append(f);a.append(e);FilterItemTypes($("#itemTypeSelection option:first").val())}function SellItem(){if($("#sellSelection").val()!==null){itemId=$("#sellSelection").val();vc.ms.Sell(itemId,ProcessSale)}}
function DisplayItemInfo(){var a=$("#itemSelection option").index($(":selected"));if(a<0)a=0;a=MyCharacter.Inventories.Personal[a].Description;$("#itemDescription").text(a)}function BuyItem(){MyCharacter.Inventories.Personal.length<20&&vc.ms.Buy($("#itemSelection").val(),ProcessPurchase)}
function DisplayItemInfo(a){a!==undefined&&$("<div><div class='row'><span class='label'>Name</span><span class='value'>"+a.Name+"</span></div><div class='row'><span class='label'>IC</span><span class='value'>"+a.ItemClass+"</span></div><div class='row'><span class='label'>Buy Price</span><span class='value'>"+a.BuyPrice+"</span></div><div class='row'><span class='label'>Sell Price</span><span class='value'>"+a.SellPrice+"</span></div></div>").dialog({title:"Details for "+a.Name})}
function FilterItemTypes(a){var b={},d=$("#itemSelection").empty(),e=V2Core.ItemTypes[2][a];for(item in V2Core.ItemTypes[2][a])if(item!="remove"){b=e[item];if(item==0)var f=" selected='selected'";d.append("<option value='"+b.ItemId+"'"+f+">"+b.Name+" - "+b.BuyPrice+"</option>")}}
function ProcessPurchase(a){if(a.Result==vc.ER_SUCCESS){a=a.Data;MyCharacter.Inventories.Personal[MyCharacter.Inventories.Personal.length]=a;MyCharacter.Gold-=a.BuyPrice;vc.i.UpdateStats();BuildInitialInventory();BuildInventoryLists();BuildGameWindow()}}
function ProcessSale(a,b){if(a.Result==vc.ER_SUCCESS){var d={},e=0,f;for(f in MyCharacter.Inventories.Personal)if(isInteger(f)){if(MyCharacter.Inventories.Personal[f].ItemId==b)d=MyCharacter.Inventories.Personal[f];e++}e--;d=d.SellPrice;MyCharacter.Inventories.Personal.remove(e);MyCharacter.Gold+=d;vc.i.UpdateStats();BuildInitialInventory();BuildInventoryLists();BuildGameWindow()}}
function BuildShrine(a){var b=MyCharacter.CurrentMap.Places[MyCharacter.PositionY][MyCharacter.PositionX],d="Shrine";if(b.Name!==undefined)d=b.Name;b=$("<form id='shrineForm'><h1>"+d+"</h1></form>");if(MyCharacter.Health>0)b.append("<h2>Why are you here? You're not dead.</h2>");else{d=$("<button type='submit' id='reviveButton' class='button'>Revive</button>");d.bind("click",function(e){e.preventDefault();vc.ms.Revive(ReviveCharacter)});b.append(d)}$(a).append(b)}
function BuildInitialInventory(){$("#itemsWindow").html("");var a=vc.is.TypeMapping,b="",d=window.MyCharacter.Equipment,e=[];b={};for(var f={},g=0;g<4;g++)if(d!==undefined&&d[g]!==undefined){e=d[g];for(var h in e)if(h!="remove"){b=a[g];if(e.length>1)b+=" "+(h*1+1);f=$("<select class='"+a[g]+" itemType_"+g+"'><option value='0'>NONE</option></select>");$selectRow=$("<div class='itemSelection' />").append("<span class='itemType'>"+b+"</span>").append(f);if(e[h].ItemId!==null){b=e[h];$("<option value='"+
b.ItemId+"' selected='selected'>"+b.Name+"</option>").prependTo(f)}$("#itemsWindow").append($selectRow)}}$("#chatChannels .ui-tabs-panel").css({height:$(window).height()-432+"px"})}function LoadInventory(a){if(a.Result==vc.ER_SUCCESS){window.MyCharacter.Inventories.Personal=a.Data;BuildInitialInventory();BuildInventoryLists()}BuildMap();$("#loading").animate({opacity:0},500,function(){$("#loading").remove()})}
function BuildInventoryLists(){var a=$("#itemsWindow select"),b={},d={},e=vc.is.TypeMapping;d=window.MyCharacter.Inventories.Personal;for(var f in d)if(f!="remove"){b=d[f];if(b!==undefined&&b!=={}&&b.ItemId!="undefined"&&b.ItemId!==undefined){$("select."+e[b.SlotType],a);$("<option value='"+b.ItemId+"'>"+b.Name+"</option>").appendTo($("select."+e[b.SlotType]))}}}
function InsertChat(a,b){var d=$("#chatChannels input[value='"+b+"']").parent(),e=$("a[href='#"+d.attr("id")+"']").parent();a[0]!==undefined&&a[0].Type!=vc.ch.CHAT_TYPE_MOTD&&!e.hasClass("ui-tabs-selected")&&e.addClass("newMessage");for(x=0;x<a.length;x++){e=a[x];if(e!==undefined)switch(e.Type){case vc.ch.CHAT_TYPE_GENERAL:var f=$("<span class='message' />").text(e.Message);$("<div class='chatMessage'><strong>"+e.FromName+"</strong>: </div>").append(f).prependTo(d);break;case vc.ch.CHAT_TYPE_EMOTE:f=
$("<span class='message' />").text(e.Message);$("<div class='chatMessage emote'>"+e.FromName+" </div>").append(f).prependTo(d);break;case vc.ch.CHAT_TYPE_MOTD:f=$("<span class='message' />").text(e.Message);$("<div class='chatMessage motd'></div>").append(f).prependTo(d);break;default:f=$("<span class='message' />").text(e.Message);$("<div class='chatMessage'><strong>"+e.FromName+"</strong>: </div>").append(f).prependTo(d)}}}
function ProcessSystemMessage(a){for(x=0;x<a.length;x++){var b=a[x];switch(b.Message.MessageType){case 0:DisplayChannelStatusUpdate(b.Message);break;case 1:var d={};d=$("#pvpMessage").length>0?$("#pvpMessage"):$("<div id='pvpMessage' class='fightResults' />");BuildAttackMessage(b.Message.BattleData,b.Message.AttackedBy,false,d).dialog({title:"You Were Attacked!",modal:true,close:function(){$("#pvpMessage").remove()}});break;case 3:$("<div>"+b.Message.From+" has sent you "+b.Message.Amount+" gold!</div>").dialog({title:b.Message.From+
" sent you gold!"});break;case 4:vc.CheckVersion(function(e){e!==vc.Version&&alert("Your game file cache is out of date.\nPlease clear your browser's cache.")})}}}
function BuildAttackMessage(a,b,d,e){var f=["player","enemy"],g="";g={};var h=$("<div class='round' />");if(d){myActor=0;enemyActor=1}else{myActor=1;enemyActor=0}for(r in a)if(isInteger(r)){if(a[r].Actor==myActor)g="You";else{g=b;MyCharacter.Health-=a[r].Damage;vc.i.UpdateHealth()}if(myActor==1)f=["enemy","player"];g=a[r].Damage>0?$("<div class='result'><span class='attacker "+f[a[r].Actor]+"'>"+g+"</span> attacked for <span class='damage'>"+a[r].Damage+"</span></div>"):$("<div class='result'><span class='attacker "+
f[a[r].Actor]+"'>"+g+"</span> <span class='damage'>missed</span></div>");h.append(g)}e.append(h);if(a.Winner!==undefined){if(a.Winner==myActor){d?e.append("<div class='result wonFight'><span class='attacker player'>You</span> have defeated <span class='enemy'>"+b+"</span>!</span></div>"):e.append("<div class='result wonFight'><span class='attacker player'>You</span> have successfully defended yourself!</span></div>");if(a.Gold!==undefined)MyCharacter.Gold+=a.Gold;if(a.Experience!==undefined)MyCharacter.Experience+=
a.Experience;if(a.AlignGood!==undefined)MyCharacter.AlignGood=a.AlignGood;if(a.AlignOrder!==undefined)MyCharacter.AlignOrder=a.AlignOrder;if(a.LevelUp!==undefined&&a.LevelUp==true){e.append("<div class='result levelUp'><span class='attacker player'>You</span> have levelled up! <a href='#' class='chooseStats button'>Choose Stats</a></span></div>");MyCharacter.FreeLevels++}}else{e.append("<div class='result lostFight'><span class='attacker enemy'>You</span> were defeated!</span></div>");MyCharacter.Health=
0;MyCharacter.Gold=0}vc.i.UpdateStats()}return e}
function DisplayChannelStatusUpdate(a){var b=$("input[value='"+a.ChannelId+"']").parent();if(window.MyCharacter.Channels[a.ChannelId]===undefined)$("<div class='chatMessage system'>"+chatobj.FromName+" invited you to join <span class='channelName'>"+a.Name+"</span>! <a href='#' class='joinChannel'>Click here to join.</a></div>").dialog({title:"Chat Room Invitation"});else if(window.MyCharacter.Channels[a.ChannelId].Permissions.isJoined==1&&a.isJoined==0){LeaveChannel(a.ChannelId);$("<div class='chatMessage system'>You have been kicked from <span class='channelName'>"+
a.Name+"</span>!</div>").dialog({title:"Kicked From Chat Room"})}else{window.MyCharacter.Channels[a.ChannelId].Permissions.Write==1&&a.Write==0&&$("<div class='chatMessage system'>You have been muted in this channel.</div>").prependTo(b);if(window.MyCharacter.Channels[a.ChannelId].Permissions.Moderate==1&&a.Moderate==0)$("<div class='chatMessage system'>You are no longer a mod in this channel.</div>").prependTo(b);else window.MyCharacter.Channels[a.ChannelId].Permissions.Administrate==1&&a.Administrate==
0&&$("<div class='chatMessage system'>You are no longer an admin in this channel.</div>").prependTo(b);window.MyCharacter.Channels[a.ChannelId].Permissions.Write==0&&a.Write==1&&$("<div class='chatMessage system'>You have been voiced in this channel.</div>").prependTo(b);if(window.MyCharacter.Channels[a.ChannelId].Permissions.Read==1&&a.Read==0)$("<div class='chatMessage system'>You have been deafened in this channel.</div>").prependTo(b);else window.MyCharacter.Channels[a.ChannelId].Permissions.Read==
0&&a.Read==1&&$("<div class='chatMessage system'>You can now read this channel.</div>").prependTo(b);if(window.MyCharacter.Channels[a.ChannelId].Permissions.Administrate==0&&a.Administrate==1)$("<div class='chatMessage system'>You are now an administrator in this channel.</div>").prependTo(b);else window.MyCharacter.Channels[a.ChannelId].Permissions.Moderate==0&&a.Moderate==1&&$("<div class='chatMessage system'>You are now a mod in this channel.</div>").prependTo(b);window.MyCharacter.Channels[a.ChannelId].Permissions=
{Read:a.Read,Write:a.Write,Moderate:a.Moderate,Administrate:a.Administrate}}}
function SubmitMessage(){var a=$("#chatInput"),b=a.val(),d=vc.ch.Utilities.ParseMessage(b);if(d.NonMessageCommand){if(d.Type=vc.cmd.ACTION_CHANNEL_SETRIGHTS){b=vc.ch.Utilities.ParseRights(d.Message);vc.ch.SetRights(window.MyCharacter.CurrentChannel,b.Character,b.Rights,function(){})}}else{vc.ch.SendMessageToChannel(MyCharacter.CurrentChannel,b,function(){});InsertChat([{Type:d.Type,FromName:MyCharacter.Name,Message:d.Message}],window.MyCharacter.CurrentChannel)}a.val("")}
function Logout(){FB.getLoginStatus(function(a){a.session&&FB.logout()});$.cookie("l",false);window.location="./index.php"}function isInteger(a){return a.toString().search(/^-?[0-9]+$/)==0}Array.prototype.remove=function(a,b){var d=this.slice((b||a)+1||this.length);this.length=a<0?this.length+a:a;return this.push.apply(this,d)};
$(function(){window.chatTabIndex=0;$("#myCharacter_Experience").progressbar();vc.cs.GetCurrentCharacter(SelectCharacter);$("#chatForm").bind("submit",function(a){a.preventDefault();SubmitMessage()});window.$tabs=$("#chatChannels").tabs({tabTemplate:'<li><a href="#{href}" class="chatChannelLabel">#{label}</a> <span class="ui-icon ui-icon-close">Remove Tab</span></li>',add:function(a,b){$(b.panel).append("<div />");$tabs.tabs("select","#"+b.panel.id)},select:function(a,b){window.MyCharacter.CurrentChannel=
$(".channelId",b.panel).val();$(b.tab).parent().removeClass("newMessage")}});$("#chatChannels span.ui-icon-close").live("click",function(){var a=$(".channelId",$($(this).siblings("a").attr("href"))).val();a!=vc.ch.StaticRooms.General&&a!=vc.ch.StaticRooms.Trade&&LeaveChannel(a)});$("#createChannelForm").dialog({autoOpen:false,title:"Create Chat Channel",width:400});$("#joinChannelForm").dialog({autoOpen:false,title:"Join Chat Channel",width:400});$("#createChannelForm form").bind("submit",function(a){a.preventDefault();
a=$("#cc_channelName").val();var b=$("#cc_channelMOTD").val();vc.ch.CreateChannel(a,b,CreateChannel)});$("#joinChannelForm form").bind("submit",function(a){a.preventDefault();a=$("#jc_channelName").val();vc.ch.JoinChannel(a,JoinChannel)});$("#quickLoginForm .button").bind("click",function(a){a.preventDefault();vc.as.Logout(Logout)});$("#createChannelLink").bind("click",function(){$("#createChannelForm").dialog("open")});$("#joinChannelLink").bind("click",function(){$("#joinChannelForm").dialog("open")});
$("#moveNW").button({icons:{primary:"ui-icon-arrowthick-1-nw"},text:false});$("#moveN").button({icons:{primary:"ui-icon-arrowthick-1-n"},text:false});$("#moveNE").button({icons:{primary:"ui-icon-arrowthick-1-ne"},text:false});$("#moveW").button({icons:{primary:"ui-icon-arrowthick-1-w"},text:false});$("#moveE").button({icons:{primary:"ui-icon-arrowthick-1-e"},text:false});$("#moveSW").button({icons:{primary:"ui-icon-arrowthick-1-sw"},text:false});$("#moveS").button({icons:{primary:"ui-icon-arrowthick-1-s"},
text:false});$("#moveSE").button({icons:{primary:"ui-icon-arrowthick-1-se"},text:false});$("#moveLook").button({icons:{primary:"ui-icon-search"},text:false});$("#movementform button").bind("click",function(a){a.preventDefault();$this=$(this);if(!$this.hasClass("look")){SetEnableMovement(false);a=$this.siblings(".x").val()*1;var b=$this.siblings(".y").val()*1,c=a+MyCharacter.PositionX*1,d=b+MyCharacter.PositionY*1;if(c>MyCharacter.CurrentMap.DimensionX-1||MyCharacter.PositionX<0)c=MyCharacter.PositionX;
if(d>MyCharacter.CurrentMap.DimensionY-1||d<0)d=MyCharacter.PositionY;vc.ms.Move(c,d,RefreshMap);a+b==1||a+b==-1?window.setTimeout(function(){SetEnableMovement(true)},750):window.setTimeout(function(){SetEnableMovement(true)},1060)}});$("#statsWindow").dialog({title:"Character Stats",autoOpen:false});$("#itemsWindow").dialog({title:"Inventory",modal:true,autoOpen:false});$(".accountActions .logOut").bind("click",function(a){a.preventDefault();vc.as.Logout(Logout)});$("#statsWindowButton").bind("click",
function(a){a.preventDefault();$("#statsWindow").dialog("open")});$("#itemsWindowButton").bind("click",function(a){a.preventDefault();$("#itemsWindow").dialog("open")});$(".chatMessage.system a.joinChannel").live("click",function(a){a.preventDefault();$this=$(this);a=$this.siblings(".channelName").text();vc.ch.JoinChannel(a,JoinChannel);$this.parentsUntil(".ui-dialog").parent().dialog("destroy").remove()});$("#itemsWindow select").live("change",function(){$this=$(this);var a=$this.attr("class").split(" ")[0];
$("#itemsWindow select").attr("disabled","disabled");var b=$this.attr("class").split(" ")[1].replace(/itemType_/,"")*1;a=$("#itemsWindow select."+a).index($this);$this.val()==0?vc.is.UnEquip(window.MyCharacter.Equipment[b][a].ItemId,b,a,UnEquipItem):vc.is.Equip($this.val(),b,a,EquipItem)})});
function EquipItem(a,b,c,d){if(a.Result==vc.ER_SUCCESS){a={};var e=vc.is.TypeMapping,f;for(f in window.MyCharacter.Inventories.Personal)if(window.MyCharacter.Inventories.Personal[f].ItemId=b){window.MyCharacter.Equipment[c][d]=window.MyCharacter.Inventories.Personal[f];delete window.MyCharacter.Inventories.Personal[f]}a=window.MyCharacter.Equipment[c][d];$("option[value="+a.ItemId+"]").remove();$("<option value='"+a.ItemId+"' selected='selected'>"+a.Name+"</option>").appendTo($("select."+e[a.SlotType]).eq(d))}$("#itemsWindow select").removeAttr("disabled")}
function UnEquipItem(a,b,c,d){if(a.Result==vc.ER_SUCCESS){a=window.MyCharacter.Equipment[c][d];b=vc.is.TypeMapping;$("option[value="+a.ItemId+"]").remove();$("<option value='"+a.ItemId+"'>"+a.Name+"</option>").appendTo($("select."+b[a.SlotType]));window.MyCharacter.Inventories.Personal[window.MyCharacter.Inventories.Personal.length]=a;window.MyCharacter.Equipment[c][d]={}}$("#itemsWindow select").removeAttr("disabled")}
function RefreshMap(a){if(a.Result==vc.ER_SUCCESS){MyCharacter.PositionX=a.Data.X;MyCharacter.PositionY=a.Data.Y;BuildMap()}}function SetEnableMovement(a){$("#movementform button").button("option","disabled",!a).removeClass("ui-state-hover")}
function CreateChannel(a){if(a.Result==vc.ER_SUCCESS){$("#cc_channelName, #cc_channelMOTD").val("");$("#createChannelForm").dialog("close");AddTab(a.Data.Name,a.Data.ChannelId,a.Data.Motd);window.MyCharacter.Channels[a.Data.ChannelId]={Motd:a.Data.Motd,Name:a.Data.Name,Permissions:{Read:1,Write:1,Moderate:1,Administrate:1,isJoined:1}}}else a.Result==vc.ER_ALREADYEXISTS?alert("Channel name already exists!"):alert("An error has occured.")}
function JoinChannel(a){if(a.Result==vc.ER_SUCCESS){$("#jc_channelName, #cc_channelMOTD").val("");$("#joinChannelForm").dialog("close");AddTab(a.Data.Name,a.Data.ChannelId,a.Data.Motd);a.Data.Permissions.isJoined=1;window.MyCharacter.Channels[a.Data.ChannelId]={Motd:a.Data.Motd,Name:a.Data.Name,Permissions:a.Data.Permissions}}else alert("An error has occured.")}
function LeaveChannel(a){var b=$("#chatChannels input[value='"+a+"']").parent();b=$("a[href='#"+b.attr("id")+"']").parent();var c=$("li",$tabs).index(b);vc.ch.PartChannel(a,function(){$tabs.tabs("remove",c)});delete window.MyCharacter.Channels[a]}
function AddTab(a,b,c){$tabs.tabs("add","#channelTabs-"+chatTabIndex,a.replace(/</g,"&lt;").replace(/>/g,"&gt;"));$("<input type='hidden' value='"+b+"' class='channelId' />").appendTo($("#channelTabs-"+chatTabIndex));InsertChat([{Type:999,FromName:"",Message:c}],b);chatTabIndex++;window.MyCharacter.CurrentChannel=b}
function FillChat(a){if(a.Result==vc.ER_SUCCESS)for(var b in a.Data)b!=0?InsertChat(a.Data[b],b):ProcessSystemMessage(a.Data[0]);$(".chatMessage:nth-child(n+50)").remove();window.setTimeout(function(){vc.ch.GetMessagesFromChannel(MyCharacter.CurrentChannel,FillChat)},4500)}
function SelectCharacter(a){window.MyCharacter=new Character;if(a.Result==vc.ER_SUCCESS){window.MyCharacter.Construct(a.Data);vc.i.UpdateStats()}for(var b in window.MyCharacter.Channels)AddTab(window.MyCharacter.Channels[b].Name,b,window.MyCharacter.Channels[b].Motd);$tabs.tabs("select",0);BuildMap();BuildInitialInventory();vc.ch.GetMessagesFromChannel(b,FillChat);vc.is.GetInventory(LoadInventory)}
function BuildMap(){$("#currentMapName").text(MyCharacter.CurrentMap.Name);$currentMap=$("#currentMap");$currentMap.empty();for(my=MyCharacter.CurrentMap.DimensionY-1;my>=0;my--){var a=$("<tr />");for(mx=0;mx<MyCharacter.CurrentMap.DimensionY;mx++){var b=$("<td />");my==MyCharacter.PositionY&&mx==MyCharacter.PositionX?b.html("<span class='mapData player'>X</span>"):b.html("<span class='mapData empty'>&nbsp;</span>");b.appendTo(a)}a.appendTo($currentMap)}$currentMap.css({height:30*MyCharacter.CurrentMap.DimensionY,
width:30*MyCharacter.CurrentMap.DimensionX})}
function BuildInitialInventory(){var a=vc.is.TypeMapping,b="",c=window.MyCharacter.Equipment,d=[];b={};for(var e={},f=0;f<4;f++)if(c!==undefined&&c[f]!==undefined){d=c[f];for(var g in d){b=a[f];if(d.length>1)b+=" "+(g*1+1);e=$("<select class='"+a[f]+" itemType_"+f+"'><option value='0'>NONE</option></select>");$selectRow=$("<div class='itemSelection' />").append("<span class='itemType'>"+b+"</span>").append(e);if(d[g].ItemId!==null){b=d[g];$("<option value='"+b.ItemId+"' selected='selected'>"+b.Name+
"</option>").prependTo(e)}$("#itemsWindow").append($selectRow)}}}function LoadInventory(a){if(a.Result==vc.ER_SUCCESS){var b={},c=vc.is.TypeMapping;window.MyCharacter.Inventories.Personal=a.Data;for(var d in MyCharacter.Inventories.Personal){b=MyCharacter.Inventories.Personal[d];b!==undefined&&b!=={}&&$("<option value='"+b.ItemId+"'>"+b.Name+"</option>").appendTo($("select."+c[b.SlotType]))}}}
function InsertChat(a,b){var c=$("#chatChannels input[value='"+b+"']").parent(),d=$("a[href='#"+c.attr("id")+"']").parent();a[0]!==undefined&&a[0].Type!=vc.ch.CHAT_TYPE_MOTD&&!d.hasClass("ui-tabs-selected")&&d.addClass("newMessage");for(x=0;x<a.length;x++){d=a[x];switch(d.Type){case vc.ch.CHAT_TYPE_GENERAL:var e=$("<span class='message' />").text(d.Message);$("<div class='chatMessage'><strong>"+d.FromName+"</strong>: </div>").append(e).prependTo(c);break;case vc.ch.CHAT_TYPE_EMOTE:e=$("<span class='message' />").text(d.Message);
$("<div class='chatMessage emote'>"+d.FromName+" </div>").append(e).prependTo(c);break;case vc.ch.CHAT_TYPE_MOTD:e=$("<span class='message' />").text(d.Message);$("<div class='chatMessage motd'></div>").append(e).prependTo(c);break;default:e=$("<span class='message' />").text(d.Message);$("<div class='chatMessage'><strong>"+d.FromName+"</strong>: </div>").append(e).prependTo(c)}}}
function ProcessSystemMessage(a){for(x=0;x<a.length;x++){var b=a[x],c=b.Message,d=$("input[value='"+c.ChannelId+"']").parent();if(window.MyCharacter.Channels[c.ChannelId]===undefined)$("<div class='chatMessage system'>"+b.FromName+" invited you to join <span class='channelName'>"+c.Name+"</span>! <a href='#' class='joinChannel'>Click here to join.</a></div>").dialog({title:"Chat Room Invitation"});else if(window.MyCharacter.Channels[c.ChannelId].Permissions.isJoined==1&&c.isJoined==0){LeaveChannel(c.ChannelId);
$("<div class='chatMessage system'>You have been kicked from <span class='channelName'>"+c.Name+"</span>!</div>").dialog({title:"Kicked From Chat Room"})}else{window.MyCharacter.Channels[c.ChannelId].Permissions.Write==1&&c.Write==0&&$("<div class='chatMessage system'>You have been muted in this channel.</div>").prependTo(d);if(window.MyCharacter.Channels[c.ChannelId].Permissions.Moderate==1&&c.Moderate==0)$("<div class='chatMessage system'>You are no longer a mod in this channel.</div>").prependTo(d);
else window.MyCharacter.Channels[c.ChannelId].Permissions.Administrate==1&&c.Administrate==0&&$("<div class='chatMessage system'>You are no longer an admin in this channel.</div>").prependTo(d);window.MyCharacter.Channels[c.ChannelId].Permissions.Write==0&&c.Write==1&&$("<div class='chatMessage system'>You have been voiced in this channel.</div>").prependTo(d);if(window.MyCharacter.Channels[c.ChannelId].Permissions.Read==1&&c.Read==0)$("<div class='chatMessage system'>You have been deafened in this channel.</div>").prependTo(d);
else window.MyCharacter.Channels[c.ChannelId].Permissions.Read==0&&c.Read==1&&$("<div class='chatMessage system'>You can now read this channel.</div>").prependTo(d);if(window.MyCharacter.Channels[c.ChannelId].Permissions.Administrate==0&&c.Administrate==1)$("<div class='chatMessage system'>You are now an administrator in this channel.</div>").prependTo(d);else window.MyCharacter.Channels[c.ChannelId].Permissions.Moderate==0&&c.Moderate==1&&$("<div class='chatMessage system'>You are now a mod in this channel.</div>").prependTo(d);
window.MyCharacter.Channels[c.ChannelId].Permissions={Read:c.Read,Write:c.Write,Moderate:c.Moderate,Administrate:c.Administrate}}}}
function SubmitMessage(){var a=$("#chatInput"),b=a.val(),c=vc.ch.Utilities.ParseMessage(b);if(c.NonMessageCommand){if(c.Type=vc.cmd.ACTION_CHANNEL_SETRIGHTS){b=vc.ch.Utilities.ParseRights(c.Message);vc.ch.SetRights(window.MyCharacter.CurrentChannel,b.Character,b.Rights,function(){})}}else{vc.ch.SendMessageToChannel(MyCharacter.CurrentChannel,b,function(){});InsertChat([{Type:c.Type,FromName:MyCharacter.Name,Message:c.Message}],window.MyCharacter.CurrentChannel)}a.val("")}
function Logout(){FB.getLoginStatus(function(a){a.session&&FB.logout()});$.cookie("l",false);window.location="./index.php"};